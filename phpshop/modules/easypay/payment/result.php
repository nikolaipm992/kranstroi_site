<?phpsession_start();$_classPath = "../../../";include($_classPath . "class/obj.class.php");include_once($_classPath . "class/mail.class.php");PHPShopObj::loadClass("base");PHPShopObj::loadClass("lang");PHPShopObj::loadClass("order");PHPShopObj::loadClass("file");PHPShopObj::loadClass("xml");PHPShopObj::loadClass("orm");PHPShopObj::loadClass("payment");PHPShopObj::loadClass("modules");PHPShopObj::loadClass("system");PHPShopObj::loadClass("security");PHPShopObj::loadClass("parser");PHPShopObj::loadClass("string");$PHPShopBase = new PHPShopBase($_classPath . "inc/config.ini");$PHPShopSystem = new PHPShopSystem();$PHPShopModules = new PHPShopModules($_classPath . "modules/");$PHPShopModules->checkInstall('easypay');class EasypayPayment extends PHPShopPaymentResult {    function EasypayPayment() {        $this->option();        parent::__construct();    }    /**     * Настройка модуля     */    function option() {        $this->payment_name = 'Easypay';		$this->log = true;        include_once(dirname(__FILE__) . '/../hook/mod_option.hook.php');        $PHPShopEasypayArray = new PHPShopEasypayArray();        $this->option = $PHPShopEasypayArray->getArray();    }    /**     * Проверка подписи     * @return boolean     */    function check()	{		$xml = $_REQUEST['xml_data'];		$this->inv_id = $_REQUEST['order_mer_code'];		$this->out_summ = $_REQUEST['sum'];		$mer_no = $_REQUEST['mer_no'];		$card = $_REQUEST['card'];		$purch_date = $_REQUEST['purch_date'];		$this->crc = $_REQUEST['notify_signature'];		$this->my_crc = md5($this->inv_id . $this->out_summ . $mer_no . $card . $purch_date . $this->option['web_key']);		if ($this->my_crc == $this->crc) {			return true;		}	}	function updateorder() {		if ($this->check()) {			// Проверяем сущ. заказа			$PHPShopOrm = new PHPShopOrm($GLOBALS['SysValue']['base']['orders']);			$PHPShopOrm->debug = $this->debug;			$row = $PHPShopOrm->select(array('uid', 'id', 'statusi'), array('uid' => "='" . $this->true_num($this->inv_id) . "'"), false, array('limit' => 1));			if (!empty($row['uid'])) {				// Лог оплат				$PHPShopOrm = new PHPShopOrm($GLOBALS['SysValue']['base']['payment']);				$PHPShopOrm->insert(array('uid_new' => $this->inv_id, 'name_new' => $this->payment_name,					'sum_new' => $this->out_summ, 'datas_new' => time()));				// Изменение статуса платежа                (new PHPShopOrderFunction((int) $row['id']))->changeStatus((int) $this->set_order_status_101(), $row['statusi']);				// Сообщение ОК				$this->done();				header("HTTP/1.0 200 OK");			}			else				$this->error();				header("HTTP/1.0 400 Bad Request");		}		else			$this->error(2);			header("HTTP/1.0 400 Bad Request");	}    }new EasypayPayment();?>